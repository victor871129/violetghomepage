<!doctype html>
<html lang="en">
<head>
    <title>Spotify Search In All My Own Playlists Global - violet.guru</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.3.1/darkly/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-w+8Gqjk9Cuo6XH9HKHG5t5I1VR4YBNdPt/29vwgfZR485eoEJZ8rJRbm3TR32P6k" crossorigin="anonymous">
    <script type="application/javascript"
            src="//cdn.rawgit.com/Alorel/console-log-html/master/console-log-html.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
            integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.2.0/src/spotify-web-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/2.0.4/dexie.min.js"></script>
    <style>
        #consoleMessages {
            list-style: none;
            border: 1px solid #000;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 100px;
        }

        .btn.btn-outline-success {
            opacity: 50%;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="https://violet.guru" id="spotifyDenied" class="btn btn-outline-success">Go to Home</a>
    <button type="button" class="btn btn-outline-success" id="resetLibrary">Reload database</button>
    <h4>Spotify Search In All My Own Playlists Global - violet.guru</h4>
    <div class="progress">
        <div id="progressBar" class="progress-bar bg-success" style="width: 5%"></div>
    </div>
    <div class="row invisible">
        <div class="col-sm">
        </div>
        <div class="col-sm">
            <label class="sr-only" for="searchInput">Search:</label>
            <div class="input-group mb-2">
                <div class="input-group-prepend">
                    <div class="input-group-text">Search:</div>
                </div>
                <input type="text" class="form-control" id="searchInput" placeholder="Search text"
                       value="Rock" autofocus>
            </div>
        </div>
        <div class="col-sm">
        </div>
    </div>
    <p>Messages (Scrollable)</p>
    <ul id="consoleMessages"></ul>
    <table id="mainTable" class="table">
        <thead>
        <tr>
            <th scope="col">Playlist</th>
            <th scope="col">Title</th>
            <th scope="col">Artist</th>
            <th scope="col">Album</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    <div>Report a bug at hello@violet.guru</div>

</div>
<script>
  ConsoleLogHTML.connect(document.getElementById("consoleMessages"));

  let accessToken;
  const playlistItems = [];
  let playlistCount = 0;
  let totalPlaylists = 0;
  let waitTime = 0;
  let db;
  const progressBar = $("#progressBar");
  const searchInput = $("#searchInput");
  const mainTable = $("#mainTable");
  const divContainer = $("div.container");
  let searchTimeout = null;

  //https://github.com/spotify/web-api-auth-examples
  $().ready(function () {
    let thisUrl = window.location.href;
    accessToken = GetHashAccessToken(thisUrl, "access_token");

    db = new Dexie("tracks_database");
    db.version(1).stores({
      tracks: '++id,titleName,artistsText,albumName,playlistName,playlistIsDollar,artistsList,playlistId'
    });

    db.tracks.count().then(function (countTracks) {
      if (countTracks === 0) {
        StartGetData();
      } else {
        console.log("Now you can search");
        FilterByParameter();
      }
    });
  });

  divContainer.on('keyup', '#searchInput', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(FilterByParameter, 1000)
  });

  divContainer.on('click', "#resetLibrary", ResetData);

  /** https://stackoverflow.com/a/29934692
   * @return {string}
   */
  function GetHashAccessToken(thisUrl, param) {
    return new URL(thisUrl).hash.split('&').filter(function (el) {
      if (el.match(param) !== null) return true;
    })[0].split('=')[1];
  }

  function ResetData() {
    db.delete().then(StartGetData);
  }

  function StartGetData() {
    console.log("Loading playlists names");
    progressBar.width(5 + "%");
    const musicApi = new SpotifyWebApi();
    musicApi.setAccessToken(accessToken);
    musicApi.getMe(null, null)
      .then(function (data) {
        //console.log('User', data);
        GetPlaylists(musicApi, data.id, 0);
      }, ErrorHandling);
  }

  function GetPlaylists(musicApi, userId, offsetValue) {
    const userTracks = [];
    //console.log("Get Playlist " + offsetValue);

    //https://github.com/JMPerez/spotify-web-api-js
    musicApi.getUserPlaylists(userId, {offset: offsetValue}, undefined)
      .then(function (data) {
        //console.log('User playlists', data);
        if (data.items.length > 0 && offsetValue < 1500) { //TESTDO Poner 15000
          data.items.forEach(function (playList) {
            if (playList.owner.id === userId) {
              playlistItems.push({id: playList.id, name: playList.name, isDollar: playList.name.includes("$$")});
            }
          });

          GetPlaylists(musicApi, userId, offsetValue + 20);

        } else {
          playlistCount = playlistItems.length;
          totalPlaylists = playlistItems.length;
          console.log("Loading tracks of " + playlistCount + " playlists");
          progressBar.width(15 + "%");
          playlistItems.forEach(function (playlistItem) {
            waitTime += 100;
            setTimeout(function () {
              TracksFromPlaylist(musicApi, playlistItem, userTracks);
            }, waitTime);
          });
        }
      }, ErrorHandling);
  }

  function TracksFromPlaylist(musicApi, playlistItem, userTracks) {
    //console.log("TracksFromPlaylist");
    musicApi.getPlaylist(playlistItem.id, undefined, undefined)
      .then(function (data) {
        playlistCount--;

        //console.log('Current data', data);
        data.tracks.items.forEach(function (trackInfo, index) {
          //console.log('Track info', trackInfo);
          progressBar.width(15 + 80 * (totalPlaylists - playlistCount) / totalPlaylists + "%");
          userTracks.push({
            playlistId: playlistItem.id,
            playlistName: playlistItem.name,
            playlistIsDollar: playlistItem.isDollar,
            track: trackInfo.track
          });

          if (playlistCount === 0 && index === data.tracks.items.length - 1) {
            //console.log("userTracks", userTracks.length, userTracks[2]);
            SendToDatabase(userTracks);
          }
        });
      }, ErrorHandling);
  }

  function ErrorHandling(err) {
    console.error(err.responseText, err.status, err);

    if(err.status === 401) {
      console.error("Denied permission, go to Home and try again");
    }
  }

  function SendToDatabase(userTracks) {
    const dataItems = [];
    userTracks.forEach(function (element) {
      const artistsList = [];
      element.track.artists.forEach(function (item) {
        artistsList.push(item.name);
      });

      dataItems.push({
        playlistId: element.playlistId,
        albumName: element.track.album.name,
        artistsList: element.track.artists,
        artistsText: artistsList.join(", "),
        titleName: element.track.name,
        playlistName: element.playlistName,
        playlistIsDollar: element.playlistIsDollar
      });
    });

    db.tracks.bulkPut(dataItems).then(() => {
      console.log("Now you can search");
      FilterByParameter();
    });
  }

  function FilterByParameter() {
    //TODO
    //no esta buscando en liked songs
    //busqueda con acentos insensitivos
    //console messages que aparezca de arriba hacia abajo. Poner mas CSS
    //Similar songs: sin necesidad de presionar bot�n, buscar duplicados a continuaci�n y guardar esa info en la db

    mainTable.find("tbody").html("");
    let queryText = searchInput.val();

    if (queryText.length < 2) {
      return;
    }

    let parameter = new RegExp(queryText, "i");

    const withDoubleDollar = false;
    db.tracks
      .filter(function (track) {
        return (withDoubleDollar || !track.playlistIsDollar) &&
          (parameter.test(track.titleName) || parameter.test(track.albumName) || parameter.test(track.artistsText));
      })
      //https://github.com/dfahlander/Dexie.js/issues/161
      .toArray(a => a.sort((a, b) => a.playlistName < b.playlistName ? -1 : a.playlistName > b.playlistName ? 1 : (a.titleName < b.titleName ? -1 : a.titleName > b.titleName ? 1 : 0)))
      .then(function (result) {
        result.forEach(function (item) {
          mainTable.find("tbody").append("<tr><td>" + item.playlistName +
            "</td><td>" + item.titleName +
            "</td><td>" + item.artistsText +
            "</td><td>" + item.albumName + "</td></tr>");
        });

        progressBar.parent().addClass("invisible");
        searchInput.parent().parent().parent().removeClass("invisible");
        searchInput.focus();
      });
  }
</script>
</body>
</html>
